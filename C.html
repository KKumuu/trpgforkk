<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGM 영수증</title>
    <link rel="icon" type="image/png" href="/trpgforkk/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts: Galmuri9, Noto Sans KR, BBH Bartle, Lobster, DM Serif Text -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galmuri/dist/galmuri.css">
    <link href="https://fonts.googleapis.com/css2?family=BBH+Bartle&family=DM+Serif+Text&family=Lobster&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <!-- Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --color-bg-main: #AEDEFC;
            --color-bg-input: #FDEDED;
            --receipt-bg: #FFFFFF;
            --receipt-text: #333333;
            --receipt-accent: #F875AA;
            
            /* Font Defaults */
            --receipt-font-title: 'Galmuri9';
            --receipt-font-body: 'Galmuri9';
        }

        body {
            font-family: 'Galmuri9', sans-serif;
            background-color: var(--color-bg-main);
            color: #333;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20;
            vertical-align: middle;
        }

        #captureArea {
            padding: 40px;
            display: inline-block;
            background: transparent;
        }

        .receipt-container {
            background-color: var(--receipt-bg);
            color: var(--receipt-text);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            position: relative;
            width: 360px;
            min-height: 600px;
            padding: 35px 25px;
            margin: 0 auto;
            transition: all 0.2s ease-out;
            display: flex;
            flex-direction: column;
            font-family: var(--receipt-font-body);
        }

        .receipt-title {
            font-family: var(--receipt-font-title);
            color: var(--receipt-accent);
            line-height: 1.1;
            word-break: keep-all;
        }

        .zigzag-bottom {
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(-45deg, transparent 5px, var(--receipt-bg) 5px), 
                        linear-gradient(45deg, transparent 5px, var(--receipt-bg) 5px);
            background-size: 10px 10px;
        }

        .dotted-line {
            border-top: 2px dashed var(--receipt-text);
            opacity: 0.2;
            margin: 12px 0;
        }

        .input-card {
            background-color: var(--color-bg-input);
            border: 2px solid var(--receipt-accent);
            border-radius: 12px;
            padding: 1.5rem;
        }

        /* Minimal Button UI */
        .btn-line {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 8px 4px;
            border: 1.5px solid currentColor;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.2s;
            background: white;
            height: 52px;
            font-size: 10px;
            white-space: nowrap;
        }
        .btn-line:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-line:active { transform: translateY(0); }

        .btn-accent { color: var(--receipt-accent); border-color: var(--receipt-accent); }
        .btn-accent:hover { background: var(--receipt-accent); color: white; }
        .btn-gray { color: #6B7280; border-color: #D1D5DB; }
        .btn-gray:hover { background: #6B7280; border-color: #6B7280; color: white; }
        .btn-green { color: #10B981; border-color: #A7F3D0; }
        .btn-green:hover { background: #10B981; border-color: #10B981; color: white; }
        .btn-blue { color: #3B82F6; border-color: #BFDBFE; }
        .btn-blue:hover { background: #3B82F6; border-color: #3B82F6; color: white; }
        .btn-red { color: #EF4444; border-color: #FECACA; }
        .btn-red:hover { background: #EF4444; border-color: #EF4444; color: white; }
        .btn-youtube { color: #E53E3E; border-color: #FED7D7; }
        .btn-youtube:hover { background: #E53E3E; border-color: #E53E3E; color: white; }

        .quick-tag {
            padding: 3px 8px;
            border: 1px solid var(--receipt-accent);
            border-radius: 4px;
            font-size: 10px;
            color: var(--receipt-accent);
            background: white;
            transition: all 0.2s;
        }
        .quick-tag:hover { background: var(--receipt-accent); color: white; }

        input[type="color"] {
            -webkit-appearance: none;
            border: 2px solid #ddd;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }

        .barcode-strip { 
            height: 50px; 
            width: 100%; 
            display: block;
            margin: 0 auto;
        }

        #modalOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 320px;
            text-align: center;
            border: 3px solid var(--receipt-accent);
        }
    </style>
</head>
<body class="p-4 md:p-6 min-h-screen">

    <!-- Custom Modal -->
    <div id="modalOverlay">
        <div class="modal-content">
            <span class="material-symbols-outlined text-5xl text-red-500 mb-4">warning</span>
            <h3 class="text-lg font-bold mb-2">정말 초기화할까요?</h3>
            <p class="text-sm text-gray-500 mb-6">작성된 모든 BGM 목록이 삭제됩니다.</p>
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 p-2 border-2 border-gray-300 rounded-lg font-bold">취소</button>
                <button id="modalConfirmBtn" class="flex-1 p-2 bg-red-500 text-white rounded-lg font-bold">확인</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-5 gap-6">
        
        <!-- Left Side: Form -->
        <div class="lg:col-span-3 space-y-4">
            
            <!-- Settings -->
            <div class="input-card bg-white border-gray-200 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2 text-gray-700">
                        <span class="material-symbols-outlined">settings</span> 설정 및 디자인
                    </h2>
                    <div class="flex items-center gap-2 bg-gray-50 p-1 px-2 rounded-lg border border-gray-200">
                        <span class="text-[10px] font-bold text-gray-400">SLOT</span>
                        <select id="slotSelect" onchange="loadSlot(this.value)" class="text-xs bg-transparent outline-none font-bold text-accent">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                        <button onclick="saveToSlot()" class="text-accent hover:scale-110 transition-transform"><span class="material-symbols-outlined !text-[16px]">save</span></button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Session Title</label>
                        <input type="text" id="sessionTitle" placeholder="TITLE" class="w-full p-2 border-2 border-gray-200 rounded-lg outline-none focus:border-pink-400 text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Subtitle</label>
                        <input type="text" id="sessionSubtitle" placeholder="Subtitle" class="w-full p-2 border-2 border-gray-200 rounded-lg outline-none focus:border-pink-400 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Font Theme</label>
                        <select id="fontPresetSelect" onchange="applyFontPreset(this.value)" class="w-full p-2 border-2 border-gray-200 rounded-lg outline-none focus:border-pink-400 text-xs font-bold">
                            <option value="1">Preset 1: Galmuri9</option>
                            <option value="2">Preset 2: Casual (BBH Bartle + Noto)</option>
                            <option value="3">Preset 3: Classic (Lobster + Serif)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Footer Text</label>
                        <input type="text" id="footerMessageInput" value="call of cthulhu 7th edition fanmade scenario" class="w-full p-2 border-2 border-gray-200 rounded-lg outline-none focus:border-pink-400 text-xs">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Greeting Message</label>
                        <input type="text" id="thankYouInput" value="Thank you for your session" class="w-full p-2 border-2 border-gray-200 rounded-lg outline-none focus:border-pink-400 text-xs">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Barcode Label</label>
                        <input type="text" id="barcodeLabelInput" value="TRPG-BGM-STORE-2025" class="w-full p-2 border-2 border-gray-200 rounded-lg outline-none focus:border-pink-400 text-xs">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">GM Memo</label>
                    <textarea id="gmMemoInput" rows="1" placeholder="세션을 기념하는 짧은 메모를 남겨주세요." class="w-full p-2 border-2 border-gray-200 rounded-lg outline-none focus:border-pink-400 text-xs resize-none"></textarea>
                </div>
                
                <div class="flex flex-wrap gap-4 items-center justify-around pt-4 mt-2 border-t border-gray-100">
                    <div class="flex items-center gap-2"><input type="color" id="bgColorPicker" value="#FFFFFF"><span class="text-[10px] font-bold opacity-40 uppercase">BG</span></div>
                    <div class="flex items-center gap-2"><input type="color" id="textColorPicker" value="#333333"><span class="text-[10px] font-bold opacity-40 uppercase">TXT</span></div>
                    <div class="flex items-center gap-2"><input type="color" id="accentColorPicker" value="#F875AA"><span class="text-[10px] font-bold opacity-40 uppercase">ACC</span></div>
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="noBgToggle" class="sr-only peer">
                        <div class="w-8 h-4 bg-gray-200 rounded-full peer peer-checked:bg-pink-400 relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-4"></div>
                        <span class="text-[10px] font-bold text-gray-400 group-hover:text-pink-500">배경없이 저장</span>
                    </label>
                </div>
            </div>

            <!-- BGM Entry -->
            <div class="input-card shadow-sm">
                <h2 class="text-lg mb-4 font-bold flex items-center gap-2 text-gray-700">
                    <span class="material-symbols-outlined">library_music</span> BGM 추가
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Youtube Link / ID</label>
                        <input type="text" id="ytLink" placeholder="https://..." class="w-full p-2 border-2 border-accent/20 rounded-lg outline-none focus:border-accent text-sm bg-white/50">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Quick Scene Tags</label>
                        <div class="flex flex-wrap gap-1">
                            <button onclick="setQuickTag('일상')" class="quick-tag">#일상</button>
                            <button onclick="setQuickTag('시작')" class="quick-tag">#시작</button>
                            <button onclick="setQuickTag('엔딩')" class="quick-tag">#엔딩</button>
                            <button onclick="setQuickTag('테마')" class="quick-tag">#테마</button>
                            <button onclick="setQuickTag('공포')" class="quick-tag">#공포</button>
                            <button onclick="setQuickTag('전투')" class="quick-tag">#전투</button>
                            <button onclick="setQuickTag('보스')" class="quick-tag">#보스</button>
                            <button onclick="setQuickTag('추격')" class="quick-tag">#추격</button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Track Title</label>
                        <input type="text" id="musicTitle" class="w-full p-2 border-2 border-accent/20 rounded-lg outline-none focus:border-accent text-sm bg-white/50">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Time</label>
                        <input type="text" id="duration" maxlength="4" placeholder="0000" class="w-full p-2 border-2 border-accent/20 rounded-lg outline-none text-center focus:border-accent text-sm bg-white/50">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-[10px] font-bold text-gray-400 mb-1 block ml-1 uppercase">Manual Scene Detail</label>
                    <input type="text" id="sceneTag" placeholder="상황을 입력하세요" class="w-full p-2 border-2 border-accent/20 rounded-lg outline-none focus:border-accent text-sm bg-white/50">
                </div>

                <button onclick="addItem()" class="w-full py-3 bg-white border-2 border-accent text-accent font-bold rounded-xl hover:bg-accent hover:text-white transition-all shadow-sm active:scale-95 flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">add_circle</span> 리스트에 추가하기
                </button>
            </div>

             <!-- Action Buttons -->
             <div class="grid grid-cols-5 gap-2">
                <button onclick="downloadImage()" class="btn-line btn-gray"><span class="material-symbols-outlined">image</span>이미지</button>
                <button onclick="exportExcel()" class="btn-line btn-green"><span class="material-symbols-outlined">download</span>엑셀저장</button>
                <button onclick="document.getElementById('importFile').click()" class="btn-line btn-blue">
                    <span class="material-symbols-outlined">upload_file</span>불러오기
                    <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls" onchange="handleImport(event)">
                </button>
                <button onclick="openYouTubePlaylist()" class="btn-line btn-youtube"><span class="material-symbols-outlined">play_circle</span>재생목록</button>
                <button onclick="openResetModal()" class="btn-line btn-red"><span class="material-symbols-outlined">delete_sweep</span>초기화</button>
            </div>
        </div>

        <!-- Right Side: Preview Area -->
        <div class="lg:col-span-2 flex justify-center items-start sticky top-6">
            <div id="captureArea">
                <div id="receipt" class="receipt-container">
                    <div class="text-center mb-6">
                        <h1 class="text-[9px] font-bold mb-3 leading-none opacity-40 uppercase tracking-[0.2em]">BGM PLAYLIST</h1>
                        <p id="displaySessionTitle" class="text-3xl font-bold receipt-title">TITLE</p>
                        <p id="displaySubtitle" class="text-xs opacity-60 mt-2">Subtitle</p>
                    </div>

                    <div class="dotted-line"></div>

                    <div class="text-[9px] grid grid-cols-12 gap-2 font-bold mb-1 px-1 opacity-50 uppercase">
                        <div class="col-span-6 text-left">No. item / title</div>
                        <div class="col-span-2 text-center">time</div>
                        <div class="col-span-4 text-right">scene</div>
                    </div>

                    <div id="itemList" class="space-y-4 min-h-[150px] py-2">
                        <div class="text-center py-10 opacity-30 italic text-xs">리스트가 비어있습니다.</div>
                    </div>

                    <div class="dotted-line"></div>

                    <div class="flex justify-between items-end mb-4 px-1">
                        <div class="text-left">
                            <p class="text-[9px] opacity-60 uppercase">total items</p>
                            <p id="totalCount" class="text-lg font-bold">0</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] opacity-60 uppercase">total duration</p>
                            <p id="totalDuration" class="text-lg font-bold">00:00</p>
                        </div>
                    </div>

                    <div id="memoArea" class="hidden text-center mb-4 px-2 py-3 border-y border-dashed border-gray-200">
                        <p id="displayGmMemo" class="text-[10px] italic opacity-80 break-words leading-relaxed">GM Memo here</p>
                    </div>

                    <div class="text-center pt-2">
                        <p id="displayThankYou" class="text-[9px] opacity-60 mb-2 uppercase tracking-widest font-bold">Thank you for your session</p>
                        <div id="barcodeStrip" class="barcode-strip mb-2"></div>
                        <p id="displayFooterMessage" class="text-[8px] font-bold opacity-70 break-words px-4 leading-normal">call of cthulhu 7th edition fanmade scenario</p>
                        <p id="displayBarcodeLabel" class="text-[8px] opacity-40 mt-1 uppercase tracking-tighter">TRPG-BGM-STORE-2025</p>
                    </div>

                    <div class="zigzag-bottom" id="zigzagBottom"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800/90 text-white px-5 py-2 rounded-full opacity-0 transition-all duration-300 pointer-events-none z-50 font-bold text-xs shadow-lg">
    </div>

    <script>
        let items = [];
        let currentSlot = "1";
        let currentFontPreset = "1";

        window.onload = () => {
            loadSlot("1");
            setupEventListeners();
            generateDenseBarcode();
            initColorPickers();
        };

        function setupEventListeners() {
            bindInputToDisplay('sessionTitle', 'displaySessionTitle', "TITLE");
            bindInputToDisplay('sessionSubtitle', 'displaySubtitle', "Subtitle");
            bindInputToDisplay('thankYouInput', 'displayThankYou', "Thank you for your session");
            bindInputToDisplay('footerMessageInput', 'displayFooterMessage', "call of cthulhu 7th edition fanmade scenario");
            bindInputToDisplay('barcodeLabelInput', 'displayBarcodeLabel', "TRPG-BGM-STORE-2025");
            
            // GM Memo
            const memoInput = document.getElementById('gmMemoInput');
            const memoArea = document.getElementById('memoArea');
            const memoDisplay = document.getElementById('displayGmMemo');
            memoInput.oninput = (e) => {
                const val = e.target.value;
                memoDisplay.innerText = val;
                if (val.trim() === "") memoArea.classList.add('hidden');
                else memoArea.classList.remove('hidden');
            };

            const durationInput = document.getElementById('duration');
            durationInput.oninput = (e) => {
                let val = e.target.value.replace(/[^0-9]/g, '');
                if (val.length === 4) val = val.slice(0, 2) + ":" + val.slice(2);
                e.target.value = val;
            };

            document.getElementById('bgColorPicker').oninput = (e) => updateColor('--receipt-bg', e.target.value);
            document.getElementById('textColorPicker').oninput = (e) => updateColor('--receipt-text', e.target.value);
            document.getElementById('accentColorPicker').oninput = (e) => updateColor('--receipt-accent', e.target.value);
        }

        function bindInputToDisplay(inputId, displayId, defaultValue) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            input.oninput = (e) => {
                display.innerText = e.target.value || defaultValue;
            };
        }

        function updateColor(varName, colorValue) {
            document.documentElement.style.setProperty(varName, colorValue);
            generateDenseBarcode(); // Refresh barcode color
            renderItems();
        }

        function setQuickTag(tag) {
            document.getElementById('sceneTag').value = tag;
        }

        function applyFontPreset(preset) {
            currentFontPreset = preset;
            const root = document.documentElement;
            switch(preset) {
                case "1":
                    root.style.setProperty('--receipt-font-title', "'Galmuri9'");
                    root.style.setProperty('--receipt-font-body', "'Galmuri9'");
                    break;
                case "2":
                    root.style.setProperty('--receipt-font-title', "'BBH Bartle', cursive");
                    root.style.setProperty('--receipt-font-body', "'Noto Sans KR', sans-serif");
                    break;
                case "3":
                    root.style.setProperty('--receipt-font-title', "'Lobster', cursive");
                    root.style.setProperty('--receipt-font-body', "'DM Serif Text', serif");
                    break;
            }
            renderItems();
        }

        function initColorPickers() {
            const config = [
                { var: '--receipt-bg', id: 'bgColorPicker' },
                { var: '--receipt-text', id: 'textColorPicker' },
                { var: '--receipt-accent', id: 'accentColorPicker' }
            ];
            config.forEach(item => {
                const color = getComputedStyle(document.documentElement).getPropertyValue(item.var).trim();
                const input = document.getElementById(item.id);
                if (input) input.value = color;
            });
        }

        function saveToSlot() {
            const slotData = {
                items,
                settings: {
                    title: document.getElementById('sessionTitle').value,
                    subtitle: document.getElementById('sessionSubtitle').value,
                    thankYou: document.getElementById('thankYouInput').value,
                    footer: document.getElementById('footerMessageInput').value,
                    barcodeLabel: document.getElementById('barcodeLabelInput').value,
                    gmMemo: document.getElementById('gmMemoInput').value,
                    fontPreset: currentFontPreset,
                    colors: {
                        bg: document.getElementById('bgColorPicker').value,
                        text: document.getElementById('textColorPicker').value,
                        accent: document.getElementById('accentColorPicker').value
                    }
                }
            };
            localStorage.setItem(`bgm-slot-${currentSlot}`, JSON.stringify(slotData));
            showToast(`슬롯 ${currentSlot}에 저장되었습니다.`);
        }

        function loadSlot(slotNum) {
            currentSlot = slotNum;
            const saved = localStorage.getItem(`bgm-slot-${slotNum}`);
            if (saved) {
                const data = JSON.parse(saved);
                items = data.items || [];
                const s = data.settings || {};
                
                document.getElementById('sessionTitle').value = s.title || "";
                document.getElementById('sessionSubtitle').value = s.subtitle || "";
                document.getElementById('thankYouInput').value = s.thankYou || "Thank you for your session";
                document.getElementById('footerMessageInput').value = s.footer || "call of cthulhu 7th edition fanmade scenario";
                document.getElementById('barcodeLabelInput').value = s.barcodeLabel || "TRPG-BGM-STORE-2025";
                document.getElementById('gmMemoInput').value = s.gmMemo || "";
                
                if (s.fontPreset) {
                    currentFontPreset = s.fontPreset;
                    document.getElementById('fontPresetSelect').value = s.fontPreset;
                    applyFontPreset(s.fontPreset);
                }
                if(s.colors) {
                    updateColor('--receipt-bg', s.colors.bg);
                    updateColor('--receipt-text', s.colors.text);
                    updateColor('--receipt-accent', s.colors.accent);
                    document.getElementById('bgColorPicker').value = s.colors.bg;
                    document.getElementById('textColorPicker').value = s.colors.text;
                    document.getElementById('accentColorPicker').value = s.colors.accent;
                }
                
                document.getElementById('displaySessionTitle').innerText = s.title || "TITLE";
                document.getElementById('displaySubtitle').innerText = s.subtitle || "Subtitle";
                document.getElementById('displayThankYou').innerText = s.thankYou || "Thank you for your session";
                document.getElementById('displayFooterMessage').innerText = s.footer || "call of cthulhu 7th edition fanmade scenario";
                document.getElementById('displayBarcodeLabel').innerText = s.barcodeLabel || "TRPG-BGM-STORE-2025";
                
                const memoDisplay = document.getElementById('displayGmMemo');
                const memoArea = document.getElementById('memoArea');
                memoDisplay.innerText = s.gmMemo || "";
                if (!s.gmMemo) memoArea.classList.add('hidden');
                else memoArea.classList.remove('hidden');

            } else {
                items = [];
                document.getElementById('displaySessionTitle').innerText = "TITLE";
                document.getElementById('memoArea').classList.add('hidden');
                applyFontPreset("1");
                document.getElementById('fontPresetSelect').value = "1";
            }
            renderItems();
            generateDenseBarcode();
        }

        function extractYouTubeId(urlOrId) {
            if (!urlOrId) return null;
            const idRegex = /^[a-zA-Z0-9_-]{11}$/;
            if (idRegex.test(urlOrId)) return urlOrId;
            const urlRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i;
            const match = urlOrId.match(urlRegex);
            return match ? match[1] : null;
        }

        function addItem() {
            const title = document.getElementById('musicTitle').value.trim();
            const linkInput = document.getElementById('ytLink').value.trim();
            const videoId = extractYouTubeId(linkInput);
            const finalLink = videoId ? `https://youtu.be/${videoId}` : linkInput;
            const duration = document.getElementById('duration').value || "00:00";
            const scene = document.getElementById('sceneTag').value || "-";

            if (!title) { showToast("곡 제목을 입력해주세요."); return; }
            items.push({ id: Date.now(), title, link: finalLink, duration, scene });
            renderItems();
            
            document.getElementById('musicTitle').value = "";
            document.getElementById('ytLink').value = "";
            document.getElementById('duration').value = "";
            document.getElementById('sceneTag').value = "";
        }

        function removeItem(id) {
            items = items.filter(item => item.id !== id);
            renderItems();
        }

        function renderItems() {
            const list = document.getElementById('itemList');
            const totalCount = document.getElementById('totalCount');
            const totalDurationEl = document.getElementById('totalDuration');

            if (items.length === 0) {
                list.innerHTML = `<div class="text-center py-10 opacity-30 italic text-xs">리스트가 비어있습니다.</div>`;
                totalCount.innerText = "0";
                totalDurationEl.innerText = "00:00";
                return;
            }

            list.innerHTML = items.map((item, idx) => `
                <div class="text-[11px] grid grid-cols-12 gap-2 group relative items-start font-bold leading-snug">
                    <div class="col-span-6 text-left break-all pr-1">
                        <span class="flex items-center gap-1 flex-wrap">
                            <span class="opacity-30 mr-1 text-[9px]">${(idx+1).toString().padStart(2, '0')}</span>
                            ${item.title}
                            ${item.link ? `<a href="${item.link}" target="_blank" data-html2canvas-ignore class="text-accent opacity-50 hover:opacity-100 transition-colors"><span class="material-symbols-outlined !text-[12px]">open_in_new</span></a>` : ''}
                        </span>
                        ${item.link ? `<span class="block text-[7px] opacity-30 font-normal break-all leading-tight mt-1">${item.link}</span>` : ''}
                    </div>
                    <div class="col-span-2 text-center opacity-70">${item.duration}</div>
                    <div class="col-span-4 text-right break-words pl-1" style="color: var(--receipt-text)">${item.scene}</div>
                    <button onclick="removeItem(${item.id})" class="absolute -left-8 top-0 opacity-0 group-hover:opacity-100 text-red-500 font-bold px-1 transition-opacity">×</button>
                </div>
            `).join('');

            totalCount.innerText = items.length;
            calculateTotalDuration(totalDurationEl);
        }

        function calculateTotalDuration(element) {
            let totalSec = 0;
            items.forEach(item => {
                const parts = item.duration.split(':').map(p => parseInt(p) || 0);
                if (parts.length === 2) totalSec += parts[0] * 60 + parts[1];
                else if (parts.length === 3) totalSec += parts[0] * 3600 + parts[1] * 60 + parts[2];
            });
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            element.innerText = h > 0 ? 
                `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : 
                `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function openYouTubePlaylist() {
            const videoIds = items.map(item => extractYouTubeId(item.link)).filter(id => id !== null);
            if (videoIds.length === 0) return showToast("유효한 유튜브 링크가 없습니다.");
            window.open(`https://www.youtube.com/watch_videos?video_ids=${videoIds.join(',')}`, '_blank');
        }

        function openResetModal() { document.getElementById('modalOverlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
        function confirmReset() {
            items = [];
            renderItems();
            closeModal();
            showToast("초기화되었습니다.");
        }

        function generateDenseBarcode() {
            const strip = document.getElementById('barcodeStrip');
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--receipt-text').trim();
            let gradient = 'linear-gradient(to right, ';
            let currentPos = 0;
            while (currentPos < 100) {
                const isBlack = Math.random() > 0.4;
                const width = Math.random() * 1.5 + 0.3;
                const color = isBlack ? textColor : 'transparent';
                gradient += `${color} ${currentPos}%, ${color} ${currentPos + width}%, `;
                currentPos += width;
            }
            gradient = gradient.slice(0, -2) + ')'; 
            strip.style.background = gradient;
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (jsonData.length > 0) {
                    const mappedItems = jsonData.map(row => ({
                        id: Date.now() + Math.random(),
                        title: row["곡 제목"] || "Untitled",
                        link: row["링크"] || "",
                        duration: String(row["재생시간"] || "00:00"),
                        scene: row["장면"] || "-"
                    }));
                    items = [...items, ...mappedItems];
                    renderItems();
                    showToast("불러오기 완료!");
                }
                event.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        async function downloadImage() {
            const captureArea = document.getElementById('captureArea');
            const receipt = document.getElementById('receipt');
            const noBg = document.getElementById('noBgToggle').checked;
            const originalShadow = receipt.style.boxShadow;
            const originalBg = receipt.style.backgroundColor;
            
            receipt.style.boxShadow = 'none';
            if (noBg) {
                receipt.style.backgroundColor = 'transparent';
                document.getElementById('zigzagBottom').style.opacity = '0';
            }

            showToast("이미지 생성 중...");
            try {
                const canvas = await html2canvas(captureArea, {
                    backgroundColor: null,
                    scale: 3,
                    useCORS: true
                });
                const link = document.createElement('a');
                link.download = `TRPG_BGM_Receipt_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast("저장 완료!");
            } catch (err) {
                showToast("저장 실패");
            } finally {
                receipt.style.boxShadow = originalShadow;
                receipt.style.backgroundColor = originalBg;
                document.getElementById('zigzagBottom').style.opacity = '1';
            }
        }

        function exportExcel() {
            if (items.length === 0) return showToast("데이터가 없습니다.");
            const wsData = items.map(item => [item.title, item.link, item.duration, item.scene]);
            wsData.unshift(["곡 제목", "링크", "재생시간", "장면"]);
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BGM_List");
            XLSX.writeFile(wb, `${document.getElementById('sessionTitle').value || 'BGM'}_Playlist.xlsx`);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2500);
        }
    </script>
</body>
</html>
